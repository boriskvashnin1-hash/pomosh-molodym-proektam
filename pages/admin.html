<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Админ-панель - HelProjects</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 2rem auto;
            padding: 0 2rem;
        }
        
        .admin-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .admin-stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .admin-stat-card.warning {
            border-left: 4px solid #ecc94b;
        }
        
        .admin-stat-card.danger {
            border-left: 4px solid #f56565;
        }
        
        .admin-stat-card.success {
            border-left: 4px solid #48bb78;
        }
        
        .admin-table {
            background: white;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th {
            background: #f7fafc;
            padding: 1rem;
            text-align: left;
            font-weight: 600;
            color: #2d3748;
            border-bottom: 2px solid #e2e8f0;
        }
        
        td {
            padding: 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        
        tr:hover {
            background: #f7fafc;
        }
        
        .user-role {
            display: inline-block;
            padding: 0.3rem 0.8rem;
            border-radius: 20px;
            font-size: 0.9rem;
        }
        
        .role-admin { background: #fed7d7; color: #9b2c2c; }
        .role-teacher { background: #c6f6d5; color: #22543d; }
        .role-student { background: #bee3f8; color: #2a4365; }
        
        .action-buttons {
            display: flex;
            gap: 0.5rem;
        }
        
        .action-btn {
            padding: 0.3rem 0.6rem;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .action-btn.edit { background: #e2e8f0; color: #4a5568; }
        .action-btn.delete { background: #fed7d7; color: #c53030; }
        .action-btn.view { background: #bee3f8; color: #2a4365; }
        
        .search-box {
            margin-bottom: 2rem;
        }
        
        .search-box input {
            width: 100%;
            padding: 0.8rem;
            border: 1px solid #cbd5e0;
            border-radius: 5px;
            font-size: 1rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
        }
        
        .tab {
            padding: 1rem 2rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: bold;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-rocket"></i>
                <span>HelProjects</span>
            </a>
            <div class="nav-links">
                <a href="../index.html"><i class="fas fa-home"></i> Главная</a>
                <a href="projects.html"><i class="fas fa-project-diagram"></i> Проекты</a>
                <a href="admin.html" class="active"><i class="fas fa-cog"></i> Админ-панель</a>
                <a href="profile.html"><i class="fas fa-user"></i> Профиль</a>
                <button onclick="logout()" class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </div>
    </nav>

    <div class="admin-container">
        <h1><i class="fas fa-cog"></i> Админ-панель</h1>
        
        <div class="admin-stats">
            <div class="admin-stat-card">
                <h3><i class="fas fa-users"></i> Всего пользователей</h3>
                <p class="stat-number" id="totalUsers">0</p>
            </div>
            <div class="admin-stat-card">
                <h3><i class="fas fa-project-diagram"></i> Всего проектов</h3>
                <p class="stat-number" id="totalProjects">0</p>
            </div>
            <div class="admin-stat-card warning">
                <h3><i class="fas fa-clock"></i> Активные проекты</h3>
                <p class="stat-number" id="activeProjects">0</p>
            </div>
            <div class="admin-stat-card success">
                <h3><i class="fas fa-check-circle"></i> Завершенные</h3>
                <p class="stat-number" id="completedProjects">0</p>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchAdminTab('users')">Пользователи</div>
            <div class="tab" onclick="switchAdminTab('projects')">Все проекты</div>
            <div class="tab" onclick="switchAdminTab('reports')">Отчеты</div>
        </div>
        
        <div id="users" class="tab-content active">
            <div class="search-box">
                <input type="text" id="userSearch" placeholder="Поиск пользователей..." onkeyup="searchUsers()">
            </div>
            
            <div class="admin-table">
                <table id="usersTable">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>ФИО</th>
                            <th>Email</th>
                            <th>Класс</th>
                            <th>Дата регистрации</th>
                            <th>Проектов</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="usersTableBody">
                        <!-- Данные загружаются через JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="projects" class="tab-content">
            <div class="search-box">
                <input type="text" id="projectSearch" placeholder="Поиск проектов..." onkeyup="searchProjects()">
            </div>
            
            <div class="admin-table">
                <table id="projectsTable">
                    <thead>
                        <tr>
                            <th>Название</th>
                            <th>Автор</th>
                            <th>Предмет</th>
                            <th>Статус</th>
                            <th>Прогресс</th>
                            <th>Дата создания</th>
                            <th>Действия</th>
                        </tr>
                    </thead>
                    <tbody id="projectsTableBody">
                        <!-- Данные загружаются через JS -->
                    </tbody>
                </table>
            </div>
        </div>
        
        <div id="reports" class="tab-content">
            <div class="admin-stat-card">
                <h3><i class="fas fa-chart-bar"></i> Статистика по предметам</h3>
                <div id="subjectChart" style="height: 300px;"></div>
            </div>
            
            <div class="admin-stat-card">
                <h3><i class="fas fa-calendar-alt"></i> Активность по дням</h3>
                <div id="activityChart" style="height: 300px;"></div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>HelProjects &copy; 2024 - Платформа для школьных проектов</p>
    </footer>

    <script src="../js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/database.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <script>
        let allUsers = [];
        let allProjects = [];
        
        async function checkAdmin() {
            const { data: { user } } = await supabase.auth.getUser();
            
            if (!user) {
                window.location.href = '../index.html';
                return false;
            }
            
            // Здесь можно добавить проверку роли пользователя
            // Пока просто разрешаем доступ для всех авторизованных
            return true;
        }
        
        async function loadAdminData() {
            const isAdmin = await checkAdmin();
            if (!isAdmin) return;
            
            // Загружаем пользователей
            await loadUsers();
            
            // Загружаем все проекты
            await loadAllProjects();
            
            // Обновляем статистику
            updateAdminStats();
        }
        
        async function loadUsers() {
            const { data: profiles, error } = await supabase
                .from('profiles')
                .select('*')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Ошибка загрузки пользователей:', error);
                return;
            }
            
            allUsers = profiles;
            
            // Для каждого пользователя загружаем количество проектов
            for (let user of allUsers) {
                const { count } = await supabase
                    .from('projects')
                    .select('*', { count: 'exact', head: true })
                    .eq('user_id', user.id);
                
                user.projectCount = count || 0;
            }
            
            displayUsers(allUsers);
        }
        
        function displayUsers(users) {
            const tbody = document.getElementById('usersTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            users.forEach(user => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${user.id.substring(0, 8)}...</td>
                    <td>${user.full_name || 'Не указано'}</td>
                    <td>${user.email}</td>
                    <td>${user.class || 'Не указан'}</td>
                    <td>${new Date(user.created_at).toLocaleDateString('ru-RU')}</td>
                    <td>${user.projectCount}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewUser('${user.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn edit" onclick="editUser('${user.id}')">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteUser('${user.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('totalUsers').textContent = users.length;
        }
        
        async function loadAllProjects() {
            const { data: projects, error } = await supabase
                .from('projects')
                .select('*, profiles(full_name, class)')
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error('Ошибка загрузки проектов:', error);
                return;
            }
            
            allProjects = projects;
            displayProjectsTable(allProjects);
        }
        
        function displayProjectsTable(projects) {
            const tbody = document.getElementById('projectsTableBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            projects.forEach(project => {
                const author = project.profiles ? project.profiles.full_name : 'Неизвестно';
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${project.title}</td>
                    <td>${author}</td>
                    <td>${project.subject || 'Не указан'}</td>
                    <td>
                        <span class="project-status status-${project.status}">
                            ${getStatusText(project.status)}
                        </span>
                    </td>
                    <td>
                        <div style="background: #e2e8f0; border-radius: 10px; height: 10px;">
                            <div style="width: ${project.progress || 0}%; background: #48bb78; height: 100%; border-radius: 10px;"></div>
                        </div>
                        ${project.progress || 0}%
                    </td>
                    <td>${new Date(project.created_at).toLocaleDateString('ru-RU')}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="action-btn view" onclick="viewProject('${project.id}')">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="action-btn delete" onclick="deleteProjectAdmin('${project.id}')">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            document.getElementById('totalProjects').textContent = projects.length;
            
            const active = projects.filter(p => p.status === 'active').length;
            const completed = projects.filter(p => p.status === 'completed').length;
            
            document.getElementById('activeProjects').textContent = active;
            document.getElementById('completedProjects').textContent = completed;
        }
        
        function updateAdminStats() {
            // Статистика уже обновляется в функциях загрузки
        }
        
        function searchUsers() {
            const searchTerm = document.getElementById('userSearch').value.toLowerCase();
            
            if (!searchTerm) {
                displayUsers(allUsers);
                return;
            }
            
            const filtered = allUsers.filter(user => 
                user.full_name?.toLowerCase().includes(searchTerm) ||
                user.email?.toLowerCase().includes(searchTerm) ||
                user.class?.toLowerCase().includes(searchTerm)
            );
            
            displayUsers(filtered);
        }
        
        function searchProjects() {
            const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
            
            if (!searchTerm) {
                displayProjectsTable(allProjects);
                return;
            }
            
            const filtered = allProjects.filter(project => 
                project.title?.toLowerCase().includes(searchTerm) ||
                project.description?.toLowerCase().includes(searchTerm) ||
                project.subject?.toLowerCase().includes(searchTerm) ||
                (project.profiles && project.profiles.full_name?.toLowerCase().includes(searchTerm))
            );
            
            displayProjectsTable(filtered);
        }
        
        function switchAdminTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            document.querySelector(`[onclick="switchAdminTab('${tabName}')"]`).classList.add('active');
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'reports') {
                loadCharts();
            }
        }
        
        function getStatusText(status) {
            const statusMap = {
                'planning': 'Планирование',
                'active': 'В работе',
                'completed': 'Завершен'
            };
            return statusMap[status] || status;
        }
        
        function viewUser(userId) {
            alert(`Просмотр пользователя ${userId}`);
            // Можно открыть модальное окно с детальной информацией
        }
        
        function editUser(userId) {
            alert(`Редактирование пользователя ${userId}`);
            // Реализовать редактирование
        }
        
        async function deleteUser(userId) {
            if (!confirm('Вы уверены, что хотите удалить пользователя и все его проекты?')) {
                return;
            }
            
            // Сначала удаляем проекты пользователя
            const { error: projectsError } = await supabase
                .from('projects')
                .delete()
                .eq('user_id', userId);
            
            if (projectsError) {
                alert('Ошибка удаления проектов: ' + projectsError.message);
                return;
            }
            
            // Затем удаляем профиль
            const { error: profileError } = await supabase
                .from('profiles')
                .delete()
                .eq('id', userId);
            
            if (profileError) {
                alert('Ошибка удаления профиля: ' + profileError.message);
                return;
            }
            
            alert('Пользователь успешно удален');
            loadAdminData();
        }
        
        function viewProject(projectId) {
            window.open(`project-detail.html?id=${projectId}`, '_blank');
        }
        
        async function deleteProjectAdmin(projectId) {
            if (!confirm('Вы уверены, что хотите удалить этот проект?')) {
                return;
            }
            
            const { error } = await supabase
                .from('projects')
                .delete()
                .eq('id', projectId);
            
            if (error) {
                alert('Ошибка удаления: ' + error.message);
                return;
            }
            
            alert('Проект удален');
            loadAdminData();
        }
        
        function loadCharts() {
            // Создаем график распределения проектов по предметам
            const subjects = {};
            allProjects.forEach(project => {
                const subject = project.subject || 'Не указан';
                subjects[subject] = (subjects[subject] || 0) + 1;
            });
            
            const subjectCtx = document.createElement('canvas');
            document.getElementById('subjectChart').innerHTML = '';
            document.getElementById('subjectChart').appendChild(subjectCtx);
            
            new Chart(subjectCtx, {
                type: 'pie',
                data: {
                    labels: Object.keys(subjects),
                    datasets: [{
                        data: Object.values(subjects),
                        backgroundColor: [
                            '#667eea', '#764ba2', '#48bb78', '#ecc94b',
                            '#f56565', '#4299e1', '#ed8936'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
            
            // Создаем график активности по дням
            const activityCtx = document.createElement('canvas');
            document.getElementById('activityChart').innerHTML = '';
            document.getElementById('activityChart').appendChild(activityCtx);
            
            // Простой пример данных активности
            new Chart(activityCtx, {
                type: 'line',
                data: {
                    labels: ['Пн', 'Вт', 'Ср', 'Чт', 'Пт', 'Сб', 'Вс'],
                    datasets: [{
                        label: 'Новые проекты',
                        data: [12, 19, 8, 15, 22, 10, 5],
                        borderColor: '#667eea',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false
                }
            });
        }
        
        document.addEventListener('DOMContentLoaded', loadAdminData);
    </script>
</body>
</html>
