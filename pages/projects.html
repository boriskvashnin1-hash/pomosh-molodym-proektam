<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Все проекты - HelpProjects</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <!-- Навигация -->
    <nav class="navbar">
        <div class="container">
            <a href="../index.html" class="logo">
                <i class="fas fa-hands-helping"></i>
                <span>HelpProjects</span>
            </a>
            
            <div class="nav-links">
                <a href="../index.html"><i class="fas fa-home"></i> Главная</a>
                <a href="projects.html" class="active"><i class="fas fa-project-diagram"></i> Проекты</a>
                <a href="create.html"><i class="fas fa-plus-circle"></i> Создать</a>
                <div id="user-menu">
                    <a href="profile.html"><i class="fas fa-user"></i> Профиль</a>
                    <a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Выйти</a>
                </div>
                <div id="auth-buttons" style="display: none;">
                    <a href="../index.html" onclick="showLogin()"><i class="fas fa-sign-in-alt"></i> Войти</a>
                </div>
            </div>
            
            <button class="menu-toggle" onclick="toggleMenu()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    </nav>

    <main class="container">
        <!-- Заголовок и фильтры -->
        <div class="projects-header">
            <h1><i class="fas fa-project-diagram"></i> Все проекты</h1>
            <p>Поддержите интересные идеи учащихся</p>
            
            <div class="filters">
                <div class="search-box">
                    <i class="fas fa-search"></i>
                    <input type="text" id="search-input" placeholder="Поиск проектов..." oninput="filterProjects()">
                </div>
                
                <select id="category-filter" onchange="filterProjects()">
                    <option value="">Все категории</option>
                    <option value="technology">Технологии</option>
                    <option value="science">Наука</option>
                    <option value="art">Искусство</option>
                    <option value="ecology">Экология</option>
                    <option value="sport">Спорт</option>
                    <option value="other">Другое</option>
                </select>
                
                <select id="sort-filter" onchange="filterProjects()">
                    <option value="newest">Сначала новые</option>
                    <option value="popular">Популярные</option>
                    <option value="ending">Заканчивающиеся</option>
                    <option value="most-funded">Больше собрано</option>
                </select>
            </div>
        </div>
        
        <!-- Статистика -->
        <div class="projects-stats" id="projects-stats">
            <div class="stat-card">
                <i class="fas fa-rocket"></i>
                <div>
                    <h3 id="total-projects">0</h3>
                    <p>Всего проектов</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-hand-holding-usd"></i>
                <div>
                    <h3 id="total-funded">0 ₽</h3>
                    <p>Собрано всего</p>
                </div>
            </div>
            <div class="stat-card">
                <i class="fas fa-users"></i>
                <div>
                    <h3 id="active-projects">0</h3>
                    <p>Активных проектов</p>
                </div>
            </div>
        </div>
        
        <!-- Сетка проектов -->
        <div class="projects-grid" id="all-projects">
            <div class="loading">Загрузка проектов...</div>
        </div>
        
        <!-- Пагинация -->
        <div class="pagination" id="pagination">
            <button class="btn btn-outline" onclick="prevPage()" id="prev-btn" disabled>
                <i class="fas fa-chevron-left"></i> Назад
            </button>
            <span id="page-info">Страница 1 из 1</span>
            <button class="btn btn-outline" onclick="nextPage()" id="next-btn" disabled>
                Вперед <i class="fas fa-chevron-right"></i>
            </button>
        </div>
        
        <!-- Модальное окно поддержки -->
        <div id="support-modal" class="modal">
            <div class="modal-content">
                <span class="close" onclick="closeSupportModal()">&times;</span>
                <h2><i class="fas fa-heart"></i> Поддержать проект</h2>
                <div id="modal-project-info"></div>
                
                <form id="support-form" onsubmit="return submitSupport(event)">
                    <div class="form-group">
                        <label for="support-amount">Сумма поддержки (₽)</label>
                        <input type="number" id="support-amount" min="100" step="100" placeholder="100" required>
                        <small>Минимальная сумма: 100 ₽</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="support-message">Ваше сообщение (необязательно)</label>
                        <textarea id="support-message" rows="3" placeholder="Пожелания автору проекта..."></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="anonymous-support">
                            <span>Сделать поддержку анонимной</span>
                        </label>
                    </div>
                    
                    <button type="submit" class="btn btn-primary btn-block">
                        <i class="fas fa-heart"></i> Поддержать проект
                    </button>
                </form>
                <div id="support-message" class="message"></div>
            </div>
        </div>
    </main>

    <!-- Футер -->
    <footer class="footer">
        <div class="container">
            <div class="footer-content">
                <div class="footer-section">
                    <h3><i class="fas fa-hands-helping"></i> HelpProjects</h3>
                    <p>Краудфандинговая платформа для реализации учебных проектов учащихся.</p>
                </div>
                <div class="footer-section">
                    <h3>Навигация</h3>
                    <a href="../index.html">Главная</a>
                    <a href="projects.html">Проекты</a>
                    <a href="create.html">Создать проект</a>
                    <a href="profile.html">Профиль</a>
                </div>
            </div>
            <div class="footer-bottom">
                <p>&copy; 2025 HelpProjects. Все права защищены.</p>
            </div>
        </div>
    </footer>

    <!-- Подключаем скрипты -->
<script src="../js/config.js"></script>
<script src="../js/auth.js"></script>
<script src="../js/projects.js"></script>
<script src="../js/database.js"></script>
    <script>
        // Глобальные переменные
        let allProjects = [];
        let filteredProjects = [];
        let currentPage = 1;
        const projectsPerPage = 9;
        let currentProjectId = null;
        
        // Инициализация
        document.addEventListener('DOMContentLoaded', function() {
            // Обновляем UI авторизации
            if (window.auth) {
                window.auth.updateUI();
            }
            
            // Загружаем проекты
            loadProjects();
            
            // Закрытие модального окна при клике вне его
            const modal = document.getElementById('support-modal');
            if (modal) {
                modal.addEventListener('click', function(event) {
                    if (event.target === modal) {
                        closeSupportModal();
                    }
                });
            }
        });
        
        // Загрузка проектов
        function loadProjects() {
            try {
                allProjects = window.projectDB.getAllProjects();
                filteredProjects = [...allProjects];
                
                // Обновляем статистику
                updateStatistics();
                
                // Отображаем проекты
                displayProjects();
                
                // Обновляем пагинацию
                updatePagination();
                
            } catch (error) {
                console.error('Ошибка загрузки проектов:', error);
                document.getElementById('all-projects').innerHTML = 
                    '<div class="error">Ошибка загрузки проектов</div>';
            }
        }
        
        // Обновление статистики
        function updateStatistics() {
            const totalProjects = allProjects.length;
            const totalFunded = allProjects.reduce((sum, p) => sum + (parseFloat(p.current_amount) || 0), 0);
            const activeProjects = allProjects.filter(p => p.status === 'active').length;
            
            document.getElementById('total-projects').textContent = totalProjects;
            document.getElementById('total-funded').textContent = totalFunded.toFixed(0) + ' ₽';
            document.getElementById('active-projects').textContent = activeProjects;
        }
        
        // Отображение проектов
        function displayProjects() {
            const container = document.getElementById('all-projects');
            
            if (filteredProjects.length === 0) {
                container.innerHTML = `
                    <div style="grid-column: 1 / -1; text-align: center; padding: 60px;">
                        <i class="fas fa-search" style="font-size: 3rem; color: #ccc; margin-bottom: 20px;"></i>
                        <h3>Проекты не найдены</h3>
                        <p>Попробуйте изменить параметры поиска</p>
                    </div>
                `;
                return;
            }
            
            // Рассчитываем диапазон для текущей страницы
            const startIndex = (currentPage - 1) * projectsPerPage;
            const endIndex = startIndex + projectsPerPage;
            const pageProjects = filteredProjects.slice(startIndex, endIndex);
            
            container.innerHTML = pageProjects.map(project => `
                <div class="project-card">
                    <div class="project-image">
                        <img src="https://images.unsplash.com/photo-1523050854058-8df90110c9f1?ixlib=rb-4.0.3&auto=format&fit=crop&w=600&q=80" alt="${project.title}">
                        <div class="project-category">${getCategoryName(project.category)}</div>
                    </div>
                    <div class="project-content">
                        <h3 class="project-title">${project.title}</h3>
                        <p class="project-description">${project.description.substring(0, 100)}...</p>
                        
                        <div class="project-goal">
                            <div class="progress-bar">
                                <div class="progress" style="width: ${Math.min((project.current_amount / project.goal * 100), 100)}%"></div>
                            </div>
                            <div class="project-stats">
                                <span>${Math.round((project.current_amount / project.goal) * 100)}%</span>
                                <span>${project.current_amount} ₽ из ${project.goal} ₽</span>
                            </div>
                        </div>
                        
                        <div class="project-meta">
                            <span><i class="fas fa-user"></i> ${project.author || 'Учащийся'}</span>
                            <span><i class="fas fa-school"></i> ${project.school || ''}</span>
                        </div>
                        
                        <div class="project-actions">
                            <button onclick="openSupportModal('${project.id}')" class="btn btn-primary">
                                <i class="fas fa-heart"></i> Поддержать
                            </button>
                            <button onclick="viewProject('${project.id}')" class="btn btn-outline">
                                <i class="fas fa-eye"></i> Подробнее
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }
        
        // Фильтрация проектов
        function filterProjects() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase();
            const category = document.getElementById('category-filter').value;
            const sortBy = document.getElementById('sort-filter').value;
            
            // Фильтрация
            filteredProjects = allProjects.filter(project => {
                const matchesSearch = !searchTerm || 
                    project.title.toLowerCase().includes(searchTerm) ||
                    project.description.toLowerCase().includes(searchTerm) ||
                    (project.author && project.author.toLowerCase().includes(searchTerm));
                
                const matchesCategory = !category || project.category === category;
                
                return matchesSearch && matchesCategory;
            });
            
            // Сортировка
            switch(sortBy) {
                case 'popular':
                    filteredProjects.sort((a, b) => (b.current_amount / b.goal) - (a.current_amount / a.goal));
                    break;
                case 'ending':
                    // Сначала те, у кого меньше времени осталось
                    filteredProjects.sort((a, b) => {
                        const aDays = a.deadline ? daysUntil(a.deadline) : Infinity;
                        const bDays = b.deadline ? daysUntil(b.deadline) : Infinity;
                        return aDays - bDays;
                    });
                    break;
                case 'most-funded':
                    filteredProjects.sort((a, b) => b.current_amount - a.current_amount);
                    break;
                case 'newest':
                default:
                    filteredProjects.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                    break;
            }
            
            // Сбрасываем на первую страницу
            currentPage = 1;
            
            // Обновляем отображение
            displayProjects();
            updatePagination();
        }
        
        // Пагинация
        function updatePagination() {
            const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
            const pageInfo = document.getElementById('page-info');
            const prevBtn = document.getElementById('prev-btn');
            const nextBtn = document.getElementById('next-btn');
            
            pageInfo.textContent = `Страница ${currentPage} из ${totalPages}`;
            prevBtn.disabled = currentPage === 1;
            nextBtn.disabled = currentPage === totalPages;
        }
        
        function prevPage() {
            if (currentPage > 1) {
                currentPage--;
                displayProjects();
                updatePagination();
            }
        }
        
        function nextPage() {
            const totalPages = Math.ceil(filteredProjects.length / projectsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                displayProjects();
                updatePagination();
            }
        }
        
        // Модальное окно поддержки
        function openSupportModal(projectId) {
            const user = window.auth.getUser();
            if (!user) {
                alert('Пожалуйста, войдите в систему, чтобы поддержать проект');
                window.location.href = '../index.html';
                return;
            }
            
            currentProjectId = projectId;
            const project = window.projectDB.getProjectById(projectId);
            
            if (!project) {
                alert('Проект не найден');
                return;
            }
            
            document.getElementById('modal-project-info').innerHTML = `
                <div class="modal-project">
                    <h3>${project.title}</h3>
                    <p>${project.description.substring(0, 150)}...</p>
                    <div class="modal-progress">
                        <div class="progress-bar">
                            <div class="progress" style="width: ${Math.min((project.current_amount / project.goal * 100), 100)}%"></div>
                        </div>
                        <div class="progress-info">
                            <span>${project.current_amount} ₽ из ${project.goal} ₽</span>
                            <span>${Math.round((project.current_amount / project.goal) * 100)}%</span>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('support-modal').style.display = 'flex';
        }
        
        function closeSupportModal() {
            document.getElementById('support-modal').style.display = 'none';
            document.getElementById('support-form').reset();
            document.getElementById('support-message').innerHTML = '';
            currentProjectId = null;
        }
        
        // Поддержка проекта
        async function submitSupport(event) {
            event.preventDefault();
            
            const amount = parseFloat(document.getElementById('support-amount').value);
            const message = document.getElementById('support-message').value;
            const isAnonymous = document.getElementById('anonymous-support').checked;
            
            if (amount < 100) {
                alert('Минимальная сумма поддержки - 100 ₽');
                return;
            }
            
            const messageEl = document.getElementById('support-message');
            messageEl.innerHTML = '<div class="loading">Отправка поддержки...</div>';
            
            try {
                const result = await window.projectDB.supportProject(currentProjectId, amount);
                
                if (result.success) {
                    messageEl.innerHTML = `<div class="message success">
                        <i class="fas fa-check-circle"></i> ${result.message}
                    </div>`;
                    
                    // Сохраняем информацию о поддержке
                    const supportData = {
                        projectId: currentProjectId,
                        amount: amount,
                        message: message,
                        anonymous: isAnonymous,
                        date: new Date().toISOString(),
                        supporter: window.auth.getUser()?.email
                    };
                    
                    saveSupport(supportData);
                    
                    // Обновляем данные
                    setTimeout(() => {
                        loadProjects();
                        closeSupportModal();
                        alert('Спасибо за поддержку проекта!');
                    }, 2000);
                    
                } else {
                    throw new Error(result.message);
                }
                
            } catch (error) {
                messageEl.innerHTML = `<div class="message error">
                    <i class="fas fa-exclamation-circle"></i> ${error.message}
                </div>`;
            }
        }
        
        // Сохранение информации о поддержке
        function saveSupport(supportData) {
            const supports = JSON.parse(localStorage.getItem('helprojects_supports') || '[]');
            supports.push(supportData);
            localStorage.setItem('helprojects_supports', JSON.stringify(supports));
        }
        
        // Просмотр проекта
        function viewProject(projectId) {
            // В реальном проекте здесь была бы отдельная страница проекта
            const project = window.projectDB.getProjectById(projectId);
            if (project) {
                alert(`Проект: ${project.title}\n\nОписание: ${project.description}\n\nЦель: ${project.goal} ₽\nСобрано: ${project.current_amount} ₽`);
            }
        }
        
        // Вспомогательные функции
        function getCategoryName(category) {
            const categories = {
                'technology': 'Технологии',
                'science': 'Наука',
                'art': 'Искусство',
                'ecology': 'Экология',
                'sport': 'Спорт',
                'other': 'Другое'
            };
            return categories[category] || 'Другое';
        }
        
        function daysUntil(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diff = date.getTime() - now.getTime();
            return Math.ceil(diff / (1000 * 60 * 60 * 24));
        }
        
        // Выход
        function logout() {
            window.auth.logout();
            window.location.href = '../index.html';
        }
        
        // Мобильное меню
        function toggleMenu() {
            const navLinks = document.querySelector('.nav-links');
            navLinks.classList.toggle('active');
        }
        
        window.toggleMenu = toggleMenu;
        window.logout = logout;
    </script>
    
    <style>
        /* Стили для страницы проектов */
        .projects-header {
            text-align: center;
            margin: 40px 0;
        }
        
        .projects-header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
        }
        
        .projects-header p {
            color: #666;
            margin-bottom: 30px;
            font-size: 1.1rem;
        }
        
        .filters {
            display: flex;
            gap: 15px;
            justify-content: center;
            flex-wrap: wrap;
            margin-bottom: 30px;
        }
        
        .search-box {
            position: relative;
            flex: 1;
            max-width: 400px;
        }
        
        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #666;
        }
        
        .search-box input {
            width: 100%;
            padding: 12px 15px 12px 45px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
        }
        
        .filters select {
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }
        
        .projects-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 15px;
            display: flex;
            align-items: center;
            gap: 20px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }
        
        .stat-card i {
            font-size: 2rem;
            color: #4a6bdf;
        }
        
        .stat-card h3 {
            font-size: 1.8rem;
            margin-bottom: 5px;
            color: #333;
        }
        
        .stat-card p {
            color: #666;
            font-size: 0.9rem;
        }
        
        .project-image {
            position: relative;
        }
        
        .project-category {
            position: absolute;
            top: 15px;
            left: 15px;
            background: rgba(74, 107, 223, 0.9);
            color: white;
            padding: 5px 10px;
            border-radius: 5px;
            font-size: 0.8rem;
            font-weight: 500;
        }
        
        .project-meta {
            display: flex;
            justify-content: space-between;
            margin: 15px 0;
            font-size: 0.9rem;
            color: #666;
        }
        
        .project-meta i {
            margin-right: 5px;
        }
        
        .project-actions {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }
        
        .project-actions .btn {
            flex: 1;
        }
        
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 40px 0;
        }
        
        .modal-project {
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .modal-project h3 {
            margin-bottom: 10px;
            color: #333;
        }
        
        .modal-progress {
            margin-top: 15px;
        }
        
        .progress-info {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.9rem;
            color: #666;
        }
        
        .error {
            text-align: center;
            padding: 40px;
            color: #dc3545;
            font-size: 1.1rem;
        }
        
        @media (max-width: 768px) {
            .filters {
                flex-direction: column;
                align-items: stretch;
            }
            
            .search-box {
                max-width: none;
            }
            
            .project-actions {
                flex-direction: column;
            }
        }
    </style>
</body>
</html>
