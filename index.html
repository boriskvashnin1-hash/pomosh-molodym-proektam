<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Мой профиль - HelProjects</title>
    <link rel="stylesheet" href="../style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .profile-container {
            max-width: 1200px;
            margin: 2rem auto;
            padding: 0 20px;
        }
        
        .profile-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 2rem;
            border-radius: 10px;
            margin-bottom: 2rem;
            display: flex;
            align-items: center;
            gap: 2rem;
            flex-wrap: wrap;
        }
        
        .profile-avatar {
            width: 100px;
            height: 100px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            flex-shrink: 0;
        }
        
        .profile-info h1 {
            margin-bottom: 0.5rem;
            color: white;
        }
        
        .profile-info p {
            margin-bottom: 0.25rem;
            opacity: 0.9;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.5rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
            transition: transform 0.3s;
        }
        
        .stat-card:hover {
            transform: translateY(-5px);
        }
        
        .stat-card i {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 1rem;
        }
        
        .stat-card .stat-number {
            font-size: 2rem;
            font-weight: bold;
            color: #2d3748;
            display: block;
        }
        
        .stat-card .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }
        
        .tabs {
            display: flex;
            border-bottom: 2px solid #e2e8f0;
            margin-bottom: 2rem;
            overflow-x: auto;
        }
        
        .tab {
            padding: 1rem 1.5rem;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
            font-weight: 500;
            color: #718096;
        }
        
        .tab:hover {
            color: #667eea;
        }
        
        .tab.active {
            border-bottom-color: #667eea;
            color: #667eea;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .tab-content.active {
            display: block;
        }
        
        .edit-profile-form {
            background: white;
            padding: 2rem;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            max-width: 600px;
            margin: 0 auto;
        }
        
        .empty-projects {
            text-align: center;
            padding: 3rem;
            color: #718096;
        }
        
        .empty-projects i {
            font-size: 3rem;
            margin-bottom: 1rem;
            color: #cbd5e0;
        }
        
        @media (max-width: 768px) {
            .profile-header {
                flex-direction: column;
                text-align: center;
                gap: 1rem;
            }
            
            .tab {
                padding: 0.8rem 1rem;
                font-size: 0.9rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        @media (max-width: 480px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-container">
            <a href="../index.html" class="logo">
                <i class="fas fa-rocket"></i>
                <span>HelProjects</span>
            </a>
            <div class="nav-links">
                <a href="../index.html"><i class="fas fa-home"></i> Главная</a>
                <a href="projects.html"><i class="fas fa-project-diagram"></i> Проекты</a>
                <a href="create.html"><i class="fas fa-plus-circle"></i> Создать</a>
                <a href="profile.html" class="active"><i class="fas fa-user"></i> Профиль</a>
                <button onclick="logout()" class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Выйти
                </button>
            </div>
        </div>
    </nav>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-avatar">
                <i class="fas fa-user-graduate"></i>
            </div>
            <div class="profile-info">
                <h1 id="userFullName">Загрузка...</h1>
                <p id="userEmail">email@example.com</p>
                <p id="userClass">Класс: Не указан</p>
                <p id="userSince">Зарегистрирован: ...</p>
            </div>
        </div>
        
        <div class="stats-grid">
            <div class="stat-card">
                <i class="fas fa-project-diagram"></i>
                <div class="stat-number" id="totalProjects">0</div>
                <div class="stat-label">Всего проектов</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-tasks"></i>
                <div class="stat-number" id="activeProjects">0</div>
                <div class="stat-label">Активных проектов</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-check-circle"></i>
                <div class="stat-number" id="completedProjects">0</div>
                <div class="stat-label">Завершенных</div>
            </div>
            <div class="stat-card">
                <i class="fas fa-chart-line"></i>
                <div class="stat-number" id="avgProgress">0%</div>
                <div class="stat-label">Средний прогресс</div>
            </div>
        </div>
        
        <div class="tabs">
            <div class="tab active" onclick="switchTab('my-projects')">
                <i class="fas fa-project-diagram"></i> Мои проекты
            </div>
            <div class="tab" onclick="switchTab('edit-profile')">
                <i class="fas fa-edit"></i> Редактировать профиль
            </div>
            <div class="tab" onclick="switchTab('settings')">
                <i class="fas fa-cog"></i> Настройки
            </div>
        </div>
        
        <div id="my-projects" class="tab-content active">
            <div id="userProjectsContainer" class="projects-grid">
                <!-- Проекты пользователя будут загружены здесь -->
                <div class="loading-state">
                    <i class="fas fa-spinner fa-spin"></i> Загрузка проектов...
                </div>
            </div>
        </div>
        
        <div id="edit-profile" class="tab-content">
            <form id="editProfileForm" class="edit-profile-form">
                <div class="form-group">
                    <label for="editFullName"><i class="fas fa-user"></i> ФИО *</label>
                    <input type="text" id="editFullName" class="form-control" required>
                </div>
                
                <div class="form-group">
                    <label for="editClass"><i class="fas fa-graduation-cap"></i> Класс</label>
                    <input type="text" id="editClass" class="form-control" placeholder="Например: 10А">
                </div>
                
                <div class="form-group">
                    <label for="editEmail"><i class="fas fa-envelope"></i> Email</label>
                    <input type="email" id="editEmail" class="form-control" readonly style="background: #f5f5f5;">
                    <small class="text-muted">Email нельзя изменить</small>
                </div>
                
                <div class="form-actions">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить изменения
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="switchTab('my-projects')">
                        <i class="fas fa-times"></i> Отмена
                    </button>
                </div>
            </form>
        </div>
        
        <div id="settings" class="tab-content">
            <div class="edit-profile-form">
                <h3><i class="fas fa-cog"></i> Настройки аккаунта</h3>
                
                <div class="form-group">
                    <label><i class="fas fa-bell"></i> Уведомления</label>
                    <div class="checkbox-group">
                        <label class="checkbox">
                            <input type="checkbox" checked>
                            <span>Уведомлять о новых комментариях</span>
                        </label>
                        <label class="checkbox">
                            <input type="checkbox" checked>
                            <span>Напоминания о дедлайнах</span>
                        </label>
                    </div>
                </div>
                
                <div class="form-group">
                    <label><i class="fas fa-eye"></i> Приватность</label>
                    <select class="form-control">
                        <option value="public">Публичный профиль</option>
                        <option value="private">Только для друзей</option>
                        <option value="hidden">Скрытый профиль</option>
                    </select>
                </div>
                
                <div class="form-actions">
                    <button class="btn btn-primary">
                        <i class="fas fa-save"></i> Сохранить настройки
                    </button>
                </div>
                
                <div class="danger-zone" style="margin-top: 2rem; padding-top: 2rem; border-top: 2px solid #fed7d7;">
                    <h4 style="color: #c53030;"><i class="fas fa-exclamation-triangle"></i> Опасная зона</h4>
                    <p style="color: #718096; margin-bottom: 1rem;">Удаление аккаунта нельзя отменить</p>
                    <button type="button" class="btn btn-danger" onclick="deleteAccount()">
                        <i class="fas fa-trash"></i> Удалить аккаунт
                    </button>
                </div>
            </div>
        </div>
    </div>

    <footer class="footer">
        <p>HelProjects &copy; 2024 - Платформа для школьных проектов</p>
        <p>Создано учащимися 10 класса</p>
    </footer>

    <script src="../js/config.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="../js/auth.js"></script>
    <script src="../js/database.js"></script>
    <script src="../js/projects.js"></script>
    
    <script>
        // Глобальные переменные
        let userProfile = null;
        let userProjects = [];
        
        // Инициализация при загрузке страницы
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Страница профиля загружена');
            
            // Проверяем авторизацию
            await checkAuth();
            
            // Если пользователь не авторизован - редирект на главную
            if (!window.currentUser) {
                window.location.href = '../index.html';
                return;
            }
            
            // Загружаем данные профиля
            await loadProfile();
            
            // Загружаем проекты пользователя
            await loadUserProjects();
            
            // Инициализируем обработчики событий
            initEventListeners();
        });
        
        // Загрузка профиля пользователя
        async function loadProfile() {
            try {
                console.log('Загрузка профиля пользователя...');
                
                // Получаем текущего пользователя
                const { data: { user }, error: userError } = await supabase.auth.getUser();
                
                if (userError || !user) {
                    console.error('Ошибка получения пользователя:', userError);
                    showNotification('Ошибка загрузки профиля', 'error');
                    return;
                }
                
                console.log('Пользователь:', user);
                
                // Загружаем профиль из таблицы profiles
                const { data: profile, error: profileError } = await supabase
                    .from('profiles')
                    .select('*')
                    .eq('id', user.id)
                    .single();
                
                if (profileError) {
                    console.warn('Ошибка загрузки профиля из таблицы:', profileError);
                    
                    // Если профиля нет в таблице, создаем его
                    userProfile = {
                        id: user.id,
                        email: user.email,
                        full_name: user.user_metadata?.full_name || 'Пользователь',
                        class: user.user_metadata?.class || '',
                        created_at: user.created_at
                    };
                    
                    // Пытаемся создать профиль в базе
                    const { error: createError } = await supabase
                        .from('profiles')
                        .upsert({
                            id: user.id,
                            email: user.email,
                            full_name: user.user_metadata?.full_name || 'Пользователь',
                            class: user.user_metadata?.class || '',
                            created_at: user.created_at
                        });
                    
                    if (createError) {
                        console.error('Ошибка создания профиля:', createError);
                    }
                } else {
                    userProfile = profile;
                }
                
                // Обновляем информацию на странице
                updateProfileUI();
                
            } catch (error) {
                console.error('Критическая ошибка при загрузке профиля:', error);
                showNotification('Ошибка загрузки профиля', 'error');
            }
        }
        
        // Обновление информации профиля на странице
        function updateProfileUI() {
            if (!userProfile) return;
            
            // Основная информация
            document.getElementById('userFullName').textContent = userProfile.full_name || 'Пользователь';
            document.getElementById('userEmail').textContent = userProfile.email || 'Не указан';
            document.getElementById('userClass').textContent = `Класс: ${userProfile.class || 'Не указан'}`;
            
            // Дата регистрации
            if (userProfile.created_at) {
                const regDate = new Date(userProfile.created_at);
                document.getElementById('userSince').textContent = 
                    `Зарегистрирован: ${regDate.toLocaleDateString('ru-RU')}`;
            }
            
            // Заполняем форму редактирования
            document.getElementById('editFullName').value = userProfile.full_name || '';
            document.getElementById('editClass').value = userProfile.class || '';
            document.getElementById('editEmail').value = userProfile.email || '';
        }
        
        // Загрузка проектов пользователя
        async function loadUserProjects() {
            try {
                console.log('Загрузка проектов пользователя...');
                
                // Показываем индикатор загрузки
                document.getElementById('userProjectsContainer').innerHTML = `
                    <div class="loading-state" style="grid-column: 1/-1; text-align: center; padding: 2rem;">
                        <i class="fas fa-spinner fa-spin"></i> Загрузка проектов...
                    </div>
                `;
                
                if (!window.currentUser) {
                    console.error('Пользователь не авторизован');
                    return;
                }
                
                // Загружаем проекты пользователя
                const projects = await db.getUserProjects(window.currentUser.id);
                userProjects = projects;
                
                console.log('Загружено проектов:', projects.length);
                
                // Обновляем статистику
                updateStats(projects);
                
                // Отображаем проекты
                displayUserProjects(projects);
                
            } catch (error) {
                console.error('Ошибка загрузки проектов:', error);
                
                document.getElementById('userProjectsContainer').innerHTML = `
                    <div class="empty-state" style="grid-column: 1/-1;">
                        <i class="fas fa-exclamation-circle"></i>
                        <h3>Ошибка загрузки проектов</h3>
                        <p>${error.message}</p>
                        <button onclick="loadUserProjects()" class="btn btn-primary">
                            <i class="fas fa-redo"></i> Попробовать снова
                        </button>
                    </div>
                `;
            }
        }
        
        // Отображение проектов пользователя
        function displayUserProjects(projects) {
            const container = document.getElementById('userProjectsContainer');
            
            if (!projects || projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-projects" style="grid-column: 1/-1;">
                        <i class="fas fa-project-diagram"></i>
                        <h3>У вас пока нет проектов</h3>
                        <p>Создайте свой первый проект и начните работать над ним</p>
                        <a href="create.html" class="btn btn-primary">
                            <i class="fas fa-plus-circle"></i> Создать первый проект
                        </a>
                    </div>
                `;
                return;
            }
            
            // Очищаем контейнер
            container.innerHTML = '';
            
            // Добавляем каждый проект
            projects.forEach(project => {
                const projectCard = createProjectCard(project);
                container.appendChild(projectCard);
            });
        }
        
        // Создание карточки проекта
        function createProjectCard(project) {
            const card = document.createElement('div');
            card.className = 'project-card';
            
            const statusClass = `status-${project.status || 'planning'}`;
            const statusText = getStatusText(project.status);
            
            // Форматируем дату
            const createdDate = project.created_at 
                ? new Date(project.created_at).toLocaleDateString('ru-RU')
                : 'Неизвестно';
            
            card.innerHTML = `
                <div class="project-header" style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 1rem;">
                    <h3 style="margin: 0;">${project.title || 'Без названия'}</h3>
                    <span class="project-status ${statusClass}">
                        ${statusText}
                    </span>
                </div>
                
                <p class="project-description" style="color: #718096; margin-bottom: 1rem; flex-grow: 1;">
                    ${project.description || 'Описание отсутствует'}
                </p>
                
                <div class="project-meta" style="display: flex; gap: 1rem; color: #718096; font-size: 0.9rem; margin-bottom: 1rem;">
                    <span><i class="fas fa-book"></i> ${project.subject || 'Не указан'}</span>
                    <span><i class="fas fa-chart-line"></i> ${project.progress || 0}%</span>
                    <span><i class="fas fa-calendar"></i> ${createdDate}</span>
                </div>
                
                <div class="project-actions" style="display: flex; gap: 0.5rem;">
                    <button onclick="viewProject('${project.id}')" class="btn btn-primary btn-small">
                        <i class="fas fa-eye"></i> Подробнее
                    </button>
                    <button onclick="editProject('${project.id}')" class="btn btn-secondary btn-small">
                        <i class="fas fa-edit"></i> Редактировать
                    </button>
                </div>
            `;
            
            return card;
        }
        
        // Обновление статистики
        function updateStats(projects) {
            if (!projects) return;
            
            const total = projects.length;
            const active = projects.filter(p => p.status === 'active').length;
            const completed = projects.filter(p => p.status === 'completed').length;
            
            // Рассчитываем средний прогресс
            let avgProgress = 0;
            if (total > 0) {
                const totalProgress = projects.reduce((sum, p) => sum + (p.progress || 0), 0);
                avgProgress = Math.round(totalProgress / total);
            }
            
            // Обновляем DOM
            document.getElementById('totalProjects').textContent = total;
            document.getElementById('activeProjects').textContent = active;
            document.getElementById('completedProjects').textContent = completed;
            document.getElementById('avgProgress').textContent = avgProgress + '%';
        }
        
        // Переключение вкладок
        function switchTab(tabName) {
            console.log('Переключение на вкладку:', tabName);
            
            // Убираем активный класс у всех вкладок и контента
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Активируем выбранную вкладку
            const activeTab = document.querySelector(`[onclick="switchTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            const activeContent = document.getElementById(tabName);
            if (activeContent) {
                activeContent.classList.add('active');
            }
        }
        
        // Получение текста статуса
        function getStatusText(status) {
            const statusMap = {
                'planning': 'Планирование',
                'active': 'В работе',
                'completed': 'Завершен'
            };
            return statusMap[status] || status;
        }
        
        // Просмотр проекта
        function viewProject(projectId) {
            window.location.href = `project-detail.html?id=${projectId}`;
        }
        
        // Редактирование проекта
        function editProject(projectId) {
            window.location.href = `create.html?edit=${projectId}`;
        }
        
        // Инициализация обработчиков событий
        function initEventListeners() {
            // Обработка формы редактирования профиля
            const editForm = document.getElementById('editProfileForm');
            if (editForm) {
                editForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    await saveProfileChanges();
                });
            }
            
            // Кнопка выхода
            const logoutBtn = document.getElementById('logoutBtn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', logout);
            }
        }
        
        // Сохранение изменений профиля
        async function saveProfileChanges() {
            try {
                const fullName = document.getElementById('editFullName').value.trim();
                const userClass = document.getElementById('editClass').value.trim();
                
                if (!fullName) {
                    showNotification('Введите ФИО', 'error');
                    return;
                }
                
                const { data: { user } } = await supabase.auth.getUser();
                if (!user) {
                    showNotification('Пользователь не авторизован', 'error');
                    return;
                }
                
                // Обновляем профиль в базе данных
                const { error } = await supabase
                    .from('profiles')
                    .update({
                        full_name: fullName,
                        class: userClass,
                        updated_at: new Date().toISOString()
                    })
                    .eq('id', user.id);
                
                if (error) {
                    console.error('Ошибка обновления профиля:', error);
                    showNotification('Ошибка сохранения: ' + error.message, 'error');
                    return;
                }
                
                // Обновляем локальные данные
                userProfile.full_name = fullName;
                userProfile.class = userClass;
                
                // Обновляем UI
                updateProfileUI();
                
                // Переключаемся на вкладку проектов
                switchTab('my-projects');
                
                showNotification('Профиль успешно обновлен!', 'success');
                
            } catch (error) {
                console.error('Ошибка сохранения профиля:', error);
                showNotification('Ошибка сохранения профиля', 'error');
            }
        }
        
        // Показ уведомлений
        function showNotification(message, type = 'info') {
            // Удаляем старое уведомление если есть
            const oldNotification = document.querySelector('.notification');
            if (oldNotification) oldNotification.remove();
            
            const notification = document.createElement('div');
            notification.className = `notification notification-${type}`;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                <span>${message}</span>
                <button class="notification-close" onclick="this.parentElement.remove()">&times;</button>
            `;
            
            // Стили для уведомления
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 8px;
                z-index: 1000;
                display: flex;
                align-items: center;
                gap: 10px;
                animation: slideIn 0.3s ease;
                background: ${type === 'success' ? '#48bb78' : type === 'error' ? '#f56565' : '#4299e1'};
                color: white;
                box-shadow: 0 5px 15px rgba(0,0,0,0.2);
                max-width: 400px;
            `;
            
            document.body.appendChild(notification);
            
            // Автоматическое скрытие через 5 секунд
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        }
        
        // Удаление аккаунта
        async function deleteAccount() {
            if (!confirm('Вы уверены, что хотите удалить аккаунт? Все ваши проекты будут удалены. Это действие нельзя отменить.')) {
                return;
            }
            
            try {
                const { data: { user } } = await supabase.auth.getUser();
                
                if (!user) {
                    showNotification('Пользователь не авторизован', 'error');
                    return;
                }
                
                // Удаляем все проекты пользователя
                const { error: projectsError } = await supabase
                    .from('projects')
                    .delete()
                    .eq('user_id', user.id);
                
                if (projectsError) {
                    console.error('Ошибка удаления проектов:', projectsError);
                }
                
                // Удаляем профиль
                const { error: profileError } = await supabase
                    .from('profiles')
                    .delete()
                    .eq('id', user.id);
                
                if (profileError) {
                    console.error('Ошибка удаления профиля:', profileError);
                }
                
                // Выходим из аккаунта
                await logout();
                
                // Показываем сообщение
                showNotification('Аккаунт успешно удален', 'success');
                
                // Редирект на главную
                setTimeout(() => {
                    window.location.href = '../index.html';
                }, 2000);
                
            } catch (error) {
                console.error('Ошибка удаления аккаунта:', error);
                showNotification('Ошибка удаления аккаунта', 'error');
            }
        }
        
        // Добавляем стили для уведомлений если их нет
        if (!document.querySelector('#notification-styles')) {
            const style = document.createElement('style');
            style.id = 'notification-styles';
            style.textContent = `
                @keyframes slideIn {
                    from {
                        transform: translateX(100%);
                        opacity: 0;
                    }
                    to {
                        transform: translateX(0);
                        opacity: 1;
                    }
                }
                
                .notification-close {
                    background: none;
                    border: none;
                    color: white;
                    cursor: pointer;
                    font-size: 1.2rem;
                    margin-left: auto;
                    opacity: 0.8;
                }
                
                .notification-close:hover {
                    opacity: 1;
                }
            `;
            document.head.appendChild(style);
        }
    </script>
    <!-- В разделе <head> или перед закрывающим </body> добавьте: -->
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="js/config.js"></script>
<script src="js/auth.js"></script>
<script src="js/database.js"></script>
<script src="js/projects.js"></script>
<script src="script.js"></script>
</body>
</html>
